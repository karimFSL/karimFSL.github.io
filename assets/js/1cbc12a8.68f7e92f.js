"use strict";(globalThis.webpackChunkdocusaurus_poc=globalThis.webpackChunkdocusaurus_poc||[]).push([[5696],{231:(e,r,n)=>{n.r(r),n.d(r,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>t,metadata:()=>i,toc:()=>o});const i=JSON.parse('{"id":"microservices/patterns/circuit-breaker","title":"Circuit Breaker Pattern","description":"Concept","source":"@site/docs/microservices/patterns/circuit-breaker.md","sourceDirName":"microservices/patterns","slug":"/microservices/patterns/circuit-breaker","permalink":"/docs/microservices/patterns/circuit-breaker","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/microservices/patterns/circuit-breaker.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Backend for Frontend (BFF)","permalink":"/docs/microservices/patterns/bff"},"next":{"title":"CQRS (Command Query Responsibility Segregation)","permalink":"/docs/microservices/patterns/cqrs"}}');var s=n(4848),l=n(8453);const t={},a="Circuit Breaker Pattern",c={},o=[{value:"Concept",id:"concept",level:2},{value:"\ud83c\udfaf Probl\xe8me r\xe9solu",id:"-probl\xe8me-r\xe9solu",level:2},{value:"\ud83d\udd04 \xc9tats du Circuit Breaker",id:"-\xe9tats-du-circuit-breaker",level:2},{value:"1. <strong>Closed</strong> (Ferm\xe9)",id:"1-closed-ferm\xe9",level:3},{value:"2. <strong>Open</strong> (Ouvert)",id:"2-open-ouvert",level:3},{value:"3. <strong>Half-Open</strong> (Semi-ouvert)",id:"3-half-open-semi-ouvert",level:3},{value:"\u2699\ufe0f Configuration typique",id:"\ufe0f-configuration-typique",level:2},{value:"\ud83d\udcbb Impl\xe9mentation",id:"-impl\xe9mentation",level:2},{value:"Java (Resilience4j)",id:"java-resilience4j",level:3},{value:"Python (pybreaker)",id:"python-pybreaker",level:3},{value:"JavaScript (opossum)",id:"javascript-opossum",level:3},{value:"\ud83d\udee1\ufe0f Strat\xe9gies de Fallback",id:"\ufe0f-strat\xe9gies-de-fallback",level:2},{value:"1. Cache",id:"1-cache",level:3},{value:"2. Valeur par d\xe9faut",id:"2-valeur-par-d\xe9faut",level:3},{value:"3. D\xe9gradation fonctionnelle",id:"3-d\xe9gradation-fonctionnelle",level:3},{value:"4. Fail fast",id:"4-fail-fast",level:3},{value:"\ud83d\udcca M\xe9triques \xe0 surveiller",id:"-m\xe9triques-\xe0-surveiller",level:2},{value:"Dashboard Grafana",id:"dashboard-grafana",level:3},{value:"\ud83c\udfa8 Patterns compl\xe9mentaires",id:"-patterns-compl\xe9mentaires",level:2},{value:"Combinaison avec Retry",id:"combinaison-avec-retry",level:3},{value:"Avec Bulkhead",id:"avec-bulkhead",level:3},{value:"\u26a0\ufe0f Pi\xe8ges \xe0 \xe9viter",id:"\ufe0f-pi\xe8ges-\xe0-\xe9viter",level:2},{value:"1. Seuil trop sensible",id:"1-seuil-trop-sensible",level:3},{value:"2. Timeout trop long en Open",id:"2-timeout-trop-long-en-open",level:3},{value:"3. Pas de fallback",id:"3-pas-de-fallback",level:3},{value:"4. Circuit global",id:"4-circuit-global",level:3},{value:"\u2705 Bonnes pratiques",id:"-bonnes-pratiques",level:2},{value:"\ud83e\uddea Tests",id:"-tests",level:2},{value:"Test unitaire",id:"test-unitaire",level:3},{value:"Test d&#39;int\xe9gration",id:"test-dint\xe9gration",level:3},{value:"Ressources",id:"ressources",level:2}];function d(e){const r={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",mermaid:"mermaid",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,l.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(r.header,{children:(0,s.jsx)(r.h1,{id:"circuit-breaker-pattern",children:"Circuit Breaker Pattern"})}),"\n",(0,s.jsx)(r.h2,{id:"concept",children:"Concept"}),"\n",(0,s.jsxs)(r.p,{children:["Le ",(0,s.jsx)(r.strong,{children:"Circuit Breaker"})," est un pattern de r\xe9silience qui emp\xeache une application d'appeler continuellement un service qui risque d'\xe9chouer, prot\xe9geant ainsi le syst\xe8me contre les d\xe9faillances en cascade."]}),"\n",(0,s.jsx)(r.admonition,{title:"Analogie",type:"tip",children:(0,s.jsx)(r.p,{children:"Comme un disjoncteur \xe9lectrique qui coupe le courant lors d'une surcharge pour prot\xe9ger l'installation."})}),"\n",(0,s.jsx)(r.h2,{id:"-probl\xe8me-r\xe9solu",children:"\ud83c\udfaf Probl\xe8me r\xe9solu"}),"\n",(0,s.jsx)(r.p,{children:"Sans Circuit Breaker, quand un service est d\xe9faillant :"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Les threads s'accumulent en attente de timeout"}),"\n",(0,s.jsx)(r.li,{children:"\xc9puisement des ressources (connexions, m\xe9moire)"}),"\n",(0,s.jsx)(r.li,{children:"Effet domino sur les autres services"}),"\n",(0,s.jsx)(r.li,{children:"Temps de r\xe9ponse d\xe9grad\xe9s pour tous les utilisateurs"}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"-\xe9tats-du-circuit-breaker",children:"\ud83d\udd04 \xc9tats du Circuit Breaker"}),"\n",(0,s.jsx)(r.mermaid,{value:"stateDiagram-v2\n    [*] --\x3e Closed\n    Closed --\x3e Open : Seuil d'\xe9checs atteint\n    Open --\x3e HalfOpen : Timeout expir\xe9\n    HalfOpen --\x3e Closed : Succ\xe8s\n    HalfOpen --\x3e Open : \xc9chec"}),"\n",(0,s.jsxs)(r.h3,{id:"1-closed-ferm\xe9",children:["1. ",(0,s.jsx)(r.strong,{children:"Closed"})," (Ferm\xe9)"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:"Circuit normal, toutes les requ\xeates passent"}),"\n",(0,s.jsx)(r.li,{children:"Compte les \xe9checs"}),"\n",(0,s.jsxs)(r.li,{children:["Si le seuil est atteint \u2192 passage en ",(0,s.jsx)(r.strong,{children:"Open"})]}),"\n"]}),"\n",(0,s.jsxs)(r.h3,{id:"2-open-ouvert",children:["2. ",(0,s.jsx)(r.strong,{children:"Open"})," (Ouvert)"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["Toutes les requ\xeates sont ",(0,s.jsx)(r.strong,{children:"imm\xe9diatement rejet\xe9es"})]}),"\n",(0,s.jsx)(r.li,{children:"Pas d'appel au service d\xe9faillant"}),"\n",(0,s.jsx)(r.li,{children:"Fallback retourn\xe9 instantan\xe9ment"}),"\n",(0,s.jsxs)(r.li,{children:["Apr\xe8s un timeout \u2192 passage en ",(0,s.jsx)(r.strong,{children:"Half-Open"})]}),"\n"]}),"\n",(0,s.jsxs)(r.h3,{id:"3-half-open-semi-ouvert",children:["3. ",(0,s.jsx)(r.strong,{children:"Half-Open"})," (Semi-ouvert)"]}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:["Laisse passer ",(0,s.jsx)(r.strong,{children:"quelques requ\xeates"})," de test"]}),"\n",(0,s.jsxs)(r.li,{children:["Si succ\xe8s \u2192 retour en ",(0,s.jsx)(r.strong,{children:"Closed"})]}),"\n",(0,s.jsxs)(r.li,{children:["Si \xe9chec \u2192 retour en ",(0,s.jsx)(r.strong,{children:"Open"})]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"\ufe0f-configuration-typique",children:"\u2699\ufe0f Configuration typique"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-yaml",children:"circuitBreaker:\n  failureThreshold: 50%        # % d'\xe9checs pour ouvrir\n  slowCallThreshold: 5s        # Seuil de lenteur\n  minimumNumberOfCalls: 10     # Appels avant \xe9valuation\n  waitDurationInOpenState: 60s # Dur\xe9e en \xe9tat Open\n  permittedCallsInHalfOpen: 3  # Appels de test en Half-Open\n"})}),"\n",(0,s.jsx)(r.h2,{id:"-impl\xe9mentation",children:"\ud83d\udcbb Impl\xe9mentation"}),"\n",(0,s.jsx)(r.h3,{id:"java-resilience4j",children:"Java (Resilience4j)"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:'CircuitBreaker circuitBreaker = CircuitBreaker.of("userService", \n    CircuitBreakerConfig.custom()\n        .failureRateThreshold(50)\n        .waitDurationInOpenState(Duration.ofSeconds(60))\n        .slidingWindowSize(10)\n        .build()\n);\n\nSupplier<User> decoratedSupplier = CircuitBreaker\n    .decorateSupplier(circuitBreaker, () -> userService.getUser(id));\n\nTry<User> result = Try.ofSupplier(decoratedSupplier)\n    .recover(throwable -> getUserFromCache(id));\n'})}),"\n",(0,s.jsx)(r.h3,{id:"python-pybreaker",children:"Python (pybreaker)"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-python",children:"from pybreaker import CircuitBreaker\n\nbreaker = CircuitBreaker(\n    fail_max=5,\n    timeout_duration=60\n)\n\n@breaker\ndef call_external_service():\n    response = requests.get('http://api.example.com/data')\n    return response.json()\n\ntry:\n    data = call_external_service()\nexcept CircuitBreakerError:\n    data = get_fallback_data()\n"})}),"\n",(0,s.jsx)(r.h3,{id:"javascript-opossum",children:"JavaScript (opossum)"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-javascript",children:"const CircuitBreaker = require('opossum');\n\nconst options = {\n  timeout: 3000,\n  errorThresholdPercentage: 50,\n  resetTimeout: 30000\n};\n\nconst breaker = new CircuitBreaker(callService, options);\n\nbreaker.fallback(() => getCachedData());\n\nbreaker.fire(userId)\n  .then(data => console.log(data))\n  .catch(err => console.error(err));\n"})}),"\n",(0,s.jsx)(r.h2,{id:"\ufe0f-strat\xe9gies-de-fallback",children:"\ud83d\udee1\ufe0f Strat\xe9gies de Fallback"}),"\n",(0,s.jsx)(r.h3,{id:"1-cache",children:"1. Cache"}),"\n",(0,s.jsx)(r.p,{children:"Retourner des donn\xe9es en cache (m\xeame p\xe9rim\xe9es)"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:".recover(throwable -> {\n    return cache.get(key)\n        .orElseThrow(() -> new ServiceUnavailableException());\n})\n"})}),"\n",(0,s.jsx)(r.h3,{id:"2-valeur-par-d\xe9faut",children:"2. Valeur par d\xe9faut"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:".recover(throwable -> User.defaultUser())\n"})}),"\n",(0,s.jsx)(r.h3,{id:"3-d\xe9gradation-fonctionnelle",children:"3. D\xe9gradation fonctionnelle"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:".recover(throwable -> {\n    // Retourner profil sans recommandations\n    return new UserProfile(userId, name, Collections.emptyList());\n})\n"})}),"\n",(0,s.jsx)(r.h3,{id:"4-fail-fast",children:"4. Fail fast"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:'.recover(throwable -> {\n    throw new ServiceUnavailableException("Service temporairement indisponible");\n})\n'})}),"\n",(0,s.jsx)(r.h2,{id:"-m\xe9triques-\xe0-surveiller",children:"\ud83d\udcca M\xe9triques \xe0 surveiller"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"\xc9tat du circuit"})," : Open/Closed/HalfOpen"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Taux d'\xe9chec"})," : % de requ\xeates en erreur"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Nombre d'appels rejet\xe9s"})," : requ\xeates bloqu\xe9es en \xe9tat Open"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Latence"})," : temps de r\xe9ponse moyen"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Taux de fallback"})," : fr\xe9quence d'utilisation du fallback"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"dashboard-grafana",children:"Dashboard Grafana"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-promql",children:'# \xc9tat du circuit\nresilience4j_circuitbreaker_state{name="userService"}\n\n# Taux d\'\xe9chec\nrate(resilience4j_circuitbreaker_calls_total{kind="failed"}[5m])\n\n# Appels rejet\xe9s\nresilience4j_circuitbreaker_not_permitted_calls_total\n'})}),"\n",(0,s.jsx)(r.h2,{id:"-patterns-compl\xe9mentaires",children:"\ud83c\udfa8 Patterns compl\xe9mentaires"}),"\n",(0,s.jsx)(r.h3,{id:"combinaison-avec-retry",children:"Combinaison avec Retry"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:'Retry retry = Retry.ofDefaults("userService");\nCircuitBreaker circuitBreaker = CircuitBreaker.ofDefaults("userService");\n\nSupplier<User> supplier = () -> userService.getUser(id);\n\nSupplier<User> decoratedSupplier = Decorators\n    .ofSupplier(supplier)\n    .withRetry(retry)           // D\'abord retry\n    .withCircuitBreaker(circuitBreaker)  // Puis circuit breaker\n    .withFallback(ex -> getUserFromCache(id))\n    .decorate();\n'})}),"\n",(0,s.jsx)(r.h3,{id:"avec-bulkhead",children:"Avec Bulkhead"}),"\n",(0,s.jsx)(r.p,{children:"Limiter les ressources consomm\xe9es m\xeame avant l'ouverture du circuit"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:'Bulkhead bulkhead = Bulkhead.of("userService", BulkheadConfig.custom()\n    .maxConcurrentCalls(10)\n    .build());\n\nSupplier<User> decoratedSupplier = Decorators\n    .ofSupplier(supplier)\n    .withBulkhead(bulkhead)\n    .withCircuitBreaker(circuitBreaker)\n    .decorate();\n'})}),"\n",(0,s.jsx)(r.h2,{id:"\ufe0f-pi\xe8ges-\xe0-\xe9viter",children:"\u26a0\ufe0f Pi\xe8ges \xe0 \xe9viter"}),"\n",(0,s.jsx)(r.h3,{id:"1-seuil-trop-sensible",children:"1. Seuil trop sensible"}),"\n",(0,s.jsx)(r.p,{children:"Circuit s'ouvre trop souvent pour des erreurs transitoires"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Solution"})," : ajuster ",(0,s.jsx)(r.code,{children:"minimumNumberOfCalls"})," et ",(0,s.jsx)(r.code,{children:"failureThreshold"})]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"2-timeout-trop-long-en-open",children:"2. Timeout trop long en Open"}),"\n",(0,s.jsx)(r.p,{children:"Service reste indisponible trop longtemps"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Solution"})," : ",(0,s.jsx)(r.code,{children:"waitDurationInOpenState"})," adapt\xe9 (30-60s g\xe9n\xe9ralement)"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"3-pas-de-fallback",children:"3. Pas de fallback"}),"\n",(0,s.jsx)(r.p,{children:"Circuit ouvert = erreur utilisateur"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Solution"})," : toujours pr\xe9voir un fallback gracieux"]}),"\n"]}),"\n",(0,s.jsx)(r.h3,{id:"4-circuit-global",children:"4. Circuit global"}),"\n",(0,s.jsx)(r.p,{children:"Un circuit partag\xe9 entre plusieurs endpoints"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Solution"})," : un circuit breaker par d\xe9pendance"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"-bonnes-pratiques",children:"\u2705 Bonnes pratiques"}),"\n",(0,s.jsxs)(r.ol,{children:["\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Un circuit par d\xe9pendance"})," : isolation fine des pannes"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Monitorer l'\xe9tat"})," : alertes sur ouverture prolong\xe9e"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Tester les fallbacks"})," : chaos engineering"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Documenter le comportement"})," : communication avec les \xe9quipes m\xe9tier"]}),"\n",(0,s.jsxs)(r.li,{children:[(0,s.jsx)(r.strong,{children:"Logs structur\xe9s"})," : tra\xe7abilit\xe9 des ouvertures/fermetures"]}),"\n"]}),"\n",(0,s.jsx)(r.h2,{id:"-tests",children:"\ud83e\uddea Tests"}),"\n",(0,s.jsx)(r.h3,{id:"test-unitaire",children:"Test unitaire"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:"@Test\nvoid shouldOpenCircuitAfterThresholdReached() {\n    // Simuler \xe9checs\n    for (int i = 0; i < 10; i++) {\n        Try.ofSupplier(decoratedSupplier);\n    }\n    \n    assertThat(circuitBreaker.getState())\n        .isEqualTo(CircuitBreaker.State.OPEN);\n}\n"})}),"\n",(0,s.jsx)(r.h3,{id:"test-dint\xe9gration",children:"Test d'int\xe9gration"}),"\n",(0,s.jsx)(r.pre,{children:(0,s.jsx)(r.code,{className:"language-java",children:'@Test\nvoid shouldReturnFallbackWhenCircuitOpen() {\n    // Ouvrir le circuit\n    openCircuit();\n    \n    User result = userService.getUser("123");\n    \n    assertThat(result).isEqualTo(User.fallbackUser());\n    verify(externalApi, never()).call();\n}\n'})}),"\n",(0,s.jsx)(r.h2,{id:"ressources",children:"Ressources"}),"\n",(0,s.jsxs)(r.ul,{children:["\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://martinfowler.com/bliki/CircuitBreaker.html",children:"Martin Fowler - Circuit Breaker"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://resilience4j.readme.io/docs/circuitbreaker",children:"Resilience4j Documentation"})}),"\n",(0,s.jsx)(r.li,{children:(0,s.jsx)(r.a,{href:"https://github.com/Netflix/Hystrix/wiki",children:"Netflix Hystrix (deprecated but educational)"})}),"\n"]})]})}function u(e={}){const{wrapper:r}={...(0,l.R)(),...e.components};return r?(0,s.jsx)(r,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,r,n)=>{n.d(r,{R:()=>t,x:()=>a});var i=n(6540);const s={},l=i.createContext(s);function t(e){const r=i.useContext(l);return i.useMemo(function(){return"function"==typeof e?e(r):{...r,...e}},[r,e])}function a(e){let r;return r=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:t(e.components),i.createElement(l.Provider,{value:r},e.children)}}}]);