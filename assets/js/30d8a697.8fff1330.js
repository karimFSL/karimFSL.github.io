"use strict";(globalThis.webpackChunkdocusaurus_poc=globalThis.webpackChunkdocusaurus_poc||[]).push([[3435],{5848:(e,n,r)=>{r.r(n),r.d(n,{assets:()=>o,contentTitle:()=>c,default:()=>u,frontMatter:()=>a,metadata:()=>t,toc:()=>l});const t=JSON.parse('{"id":"microservices/patterns/event-sourcing","title":"Event Sourcing","description":"Concept","source":"@site/docs/microservices/patterns/event-sourcing.md","sourceDirName":"microservices/patterns","slug":"/microservices/patterns/event-sourcing","permalink":"/docs/microservices/patterns/event-sourcing","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/microservices/patterns/event-sourcing.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"CQRS (Command Query Responsibility Segregation)","permalink":"/docs/microservices/patterns/cqrs"},"next":{"title":"Saga Pattern","permalink":"/docs/microservices/patterns/saga"}}');var s=r(4848),i=r(8453);const a={},c="Event Sourcing",o={},l=[{value:"Concept",id:"concept",level:2},{value:"\ud83c\udfaf Comparaison",id:"-comparaison",level:2},{value:"Approche traditionnelle (CRUD)",id:"approche-traditionnelle-crud",level:3},{value:"Event Sourcing",id:"event-sourcing-1",level:3},{value:"\ud83c\udfd7\ufe0f Architecture",id:"\ufe0f-architecture",level:2},{value:"Event Store",id:"event-store",level:3},{value:"Reconstruction de l&#39;\xe9tat",id:"reconstruction-de-l\xe9tat",level:3},{value:"\u2705 Avantages",id:"-avantages",level:2},{value:"1. Audit trail complet",id:"1-audit-trail-complet",level:3},{value:"2. Temporal queries",id:"2-temporal-queries",level:3},{value:"3. Event replay",id:"3-event-replay",level:3},{value:"4. Multiple projections",id:"4-multiple-projections",level:3},{value:"\u26a0\ufe0f Inconv\xe9nients",id:"\ufe0f-inconv\xe9nients",level:2},{value:"1. Complexit\xe9",id:"1-complexit\xe9",level:3},{value:"2. Performance en lecture",id:"2-performance-en-lecture",level:3},{value:"3. \xc9volution du sch\xe9ma",id:"3-\xe9volution-du-sch\xe9ma",level:3},{value:"\ud83d\udd27 Technologies",id:"-technologies",level:2},{value:"EventStoreDB",id:"eventstoredb",level:3},{value:"Axon Framework (Java)",id:"axon-framework-java",level:3},{value:"Kafka comme Event Store",id:"kafka-comme-event-store",level:3},{value:"\ud83c\udfa8 Patterns combin\xe9s",id:"-patterns-combin\xe9s",level:2},{value:"Event Sourcing + CQRS",id:"event-sourcing--cqrs",level:3},{value:"Event Sourcing + Saga",id:"event-sourcing--saga",level:3},{value:"\u2705 Bonnes pratiques",id:"-bonnes-pratiques",level:2},{value:"\ud83d\udcca Quand utiliser ?",id:"-quand-utiliser-",level:2},{value:"\u2705 Cas appropri\xe9s",id:"-cas-appropri\xe9s",level:3},{value:"\u274c \xc9viter si",id:"-\xe9viter-si",level:3},{value:"Ressources",id:"ressources",level:2}];function d(e){const n={a:"a",admonition:"admonition",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",ul:"ul",...(0,i.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"event-sourcing",children:"Event Sourcing"})}),"\n",(0,s.jsx)(n.h2,{id:"concept",children:"Concept"}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Event Sourcing"})," consiste \xe0 persister l'\xe9tat d'une application sous forme d'une ",(0,s.jsx)(n.strong,{children:"s\xe9quence d'\xe9v\xe9nements"})," plut\xf4t que l'\xe9tat actuel. Chaque changement est captur\xe9 comme un \xe9v\xe9nement immuable."]}),"\n",(0,s.jsx)(n.admonition,{title:"Principe",type:"tip",children:(0,s.jsx)(n.p,{children:'Au lieu de sauvegarder "Compte = 100\u20ac", on sauvegarde : "Cr\xe9dit 50\u20ac", "D\xe9bit 20\u20ac", "Cr\xe9dit 70\u20ac"'})}),"\n",(0,s.jsx)(n.h2,{id:"-comparaison",children:"\ud83c\udfaf Comparaison"}),"\n",(0,s.jsx)(n.h3,{id:"approche-traditionnelle-crud",children:"Approche traditionnelle (CRUD)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-sql",children:"-- \xc9tat actuel seulement\r\nUPDATE accounts SET balance = 100 WHERE id = 123;\n"})}),"\n",(0,s.jsxs)(n.p,{children:[(0,s.jsx)(n.strong,{children:"Perte d'information :"})," On ne sait pas comment on est arriv\xe9 \xe0 100\u20ac"]}),"\n",(0,s.jsx)(n.h3,{id:"event-sourcing-1",children:"Event Sourcing"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"events = [\r\n  { type: 'AccountCreated', amount: 0, timestamp: '2024-01-01' },\r\n  { type: 'MoneyDeposited', amount: 150, timestamp: '2024-01-02' },\r\n  { type: 'MoneyWithdrawn', amount: 50, timestamp: '2024-01-03' }\r\n];\r\n\r\n// Balance actuelle = somme des \xe9v\xe9nements\r\nbalance = events.reduce((sum, e) => {\r\n  if (e.type === 'MoneyDeposited') return sum + e.amount;\r\n  if (e.type === 'MoneyWithdrawn') return sum - e.amount;\r\n  return sum;\r\n}, 0); // = 100\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\ufe0f-architecture",children:"\ud83c\udfd7\ufe0f Architecture"}),"\n",(0,s.jsx)(n.h3,{id:"event-store",children:"Event Store"}),"\n",(0,s.jsx)(n.p,{children:"Base de donn\xe9es append-only qui stocke les \xe9v\xe9nements"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"class EventStore {\r\n  async append(streamId, event) {\r\n    await db.events.insert({\r\n      streamId: streamId,\r\n      eventType: event.type,\r\n      data: event.data,\r\n      timestamp: new Date(),\r\n      version: await this.getNextVersion(streamId)\r\n    });\r\n  }\r\n  \r\n  async getEvents(streamId, fromVersion = 0) {\r\n    return db.events.find({\r\n      streamId: streamId,\r\n      version: { $gte: fromVersion }\r\n    }).sort({ version: 1 });\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"reconstruction-de-l\xe9tat",children:"Reconstruction de l'\xe9tat"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"class Account {\r\n  constructor() {\r\n    this.balance = 0;\r\n    this.version = 0;\r\n  }\r\n  \r\n  // Appliquer un \xe9v\xe9nement\r\n  apply(event) {\r\n    switch(event.type) {\r\n      case 'MoneyDeposited':\r\n        this.balance += event.amount;\r\n        break;\r\n      case 'MoneyWithdrawn':\r\n        this.balance -= event.amount;\r\n        break;\r\n    }\r\n    this.version = event.version;\r\n  }\r\n  \r\n  // Rehydrater depuis l'Event Store\r\n  static async load(accountId, eventStore) {\r\n    const account = new Account();\r\n    const events = await eventStore.getEvents(`account-${accountId}`);\r\n    events.forEach(e => account.apply(e));\r\n    return account;\r\n  }\r\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-avantages",children:"\u2705 Avantages"}),"\n",(0,s.jsx)(n.h3,{id:"1-audit-trail-complet",children:"1. Audit trail complet"}),"\n",(0,s.jsx)(n.p,{children:"Historique immuable de tous les changements"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Qui a fait quoi et quand ?\r\nevents.forEach(e => {\r\n  console.log(`${e.timestamp}: ${e.type} by ${e.userId}`);\r\n});\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-temporal-queries",children:"2. Temporal queries"}),"\n",(0,s.jsx)(n.p,{children:"Reconstruire l'\xe9tat \xe0 n'importe quel moment"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// \xc9tat du compte au 01/01/2024 ?\r\nconst pastState = events\r\n  .filter(e => e.timestamp <= '2024-01-01')\r\n  .reduce(applyEvent, initialState);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-event-replay",children:"3. Event replay"}),"\n",(0,s.jsx)(n.p,{children:"Rejouer les \xe9v\xe9nements pour :"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Corriger des bugs"}),"\n",(0,s.jsx)(n.li,{children:"Migrer vers nouveau mod\xe8le"}),"\n",(0,s.jsx)(n.li,{children:"Analytics"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"4-multiple-projections",children:"4. Multiple projections"}),"\n",(0,s.jsx)(n.p,{children:"Cr\xe9er diff\xe9rentes vues des m\xeames donn\xe9es"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Projection 1: Solde actuel\r\nconst balance = computeBalance(events);\r\n\r\n// Projection 2: Transactions par cat\xe9gorie\r\nconst categories = groupByCategory(events);\r\n\r\n// Projection 3: Graphe temporel\r\nconst timeSeriesData = aggregateByMonth(events);\n"})}),"\n",(0,s.jsx)(n.h2,{id:"\ufe0f-inconv\xe9nients",children:"\u26a0\ufe0f Inconv\xe9nients"}),"\n",(0,s.jsx)(n.h3,{id:"1-complexit\xe9",children:"1. Complexit\xe9"}),"\n",(0,s.jsx)(n.p,{children:"Plus difficile \xe0 comprendre que CRUD"}),"\n",(0,s.jsx)(n.h3,{id:"2-performance-en-lecture",children:"2. Performance en lecture"}),"\n",(0,s.jsxs)(n.p,{children:["Besoin de reconstruire l'\xe9tat \u2192 utiliser des ",(0,s.jsx)(n.strong,{children:"snapshots"})]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Snapshot tous les 100 \xe9v\xe9nements\r\nif (version % 100 === 0) {\r\n  await snapshotStore.save(accountId, currentState, version);\r\n}\r\n\r\n// Chargement optimis\xe9\r\nconst snapshot = await snapshotStore.getLatest(accountId);\r\nconst events = await eventStore.getEvents(accountId, snapshot.version + 1);\r\nconst state = events.reduce(applyEvent, snapshot.state);\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-\xe9volution-du-sch\xe9ma",children:"3. \xc9volution du sch\xe9ma"}),"\n",(0,s.jsx)(n.p,{children:"G\xe9rer la compatibilit\xe9 des anciens \xe9v\xe9nements"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Upcasting : transformer vieux \xe9v\xe9nements\r\nconst upcast = (event) => {\r\n  if (event.version === 1) {\r\n    // V1: { type: 'Deposit', amount: 100 }\r\n    // V2: { type: 'Deposit', amount: 100, currency: 'EUR' }\r\n    return { ...event, currency: 'EUR' };\r\n  }\r\n  return event;\r\n};\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-technologies",children:"\ud83d\udd27 Technologies"}),"\n",(0,s.jsx)(n.h3,{id:"eventstoredb",children:"EventStoreDB"}),"\n",(0,s.jsx)(n.p,{children:"Base de donn\xe9es d\xe9di\xe9e \xe0 l'Event Sourcing"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"const { EventStoreDBClient } = require('@eventstore/db-client');\r\n\r\nconst client = EventStoreDBClient.connectionString(\r\n  'esdb://localhost:2113?tls=false'\r\n);\r\n\r\n// Append\r\nawait client.appendToStream('account-123', [\r\n  {\r\n    type: 'MoneyDeposited',\r\n    data: { amount: 100 }\r\n  }\r\n]);\r\n\r\n// Read\r\nconst events = client.readStream('account-123');\r\nfor await (const event of events) {\r\n  console.log(event);\r\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"axon-framework-java",children:"Axon Framework (Java)"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-java",children:"@Aggregate\r\npublic class Account {\r\n    @AggregateIdentifier\r\n    private String accountId;\r\n    private BigDecimal balance;\r\n    \r\n    @CommandHandler\r\n    public Account(CreateAccountCommand cmd) {\r\n        apply(new AccountCreatedEvent(cmd.getAccountId()));\r\n    }\r\n    \r\n    @CommandHandler\r\n    public void handle(DepositMoneyCommand cmd) {\r\n        apply(new MoneyDepositedEvent(cmd.getAmount()));\r\n    }\r\n    \r\n    @EventSourcingHandler\r\n    public void on(MoneyDepositedEvent event) {\r\n        this.balance = this.balance.add(event.getAmount());\r\n    }\r\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"kafka-comme-event-store",children:"Kafka comme Event Store"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Publier \xe9v\xe9nement\r\nawait producer.send({\r\n  topic: 'account-events',\r\n  messages: [{\r\n    key: accountId,\r\n    value: JSON.stringify({\r\n      type: 'MoneyDeposited',\r\n      amount: 100\r\n    })\r\n  }]\r\n});\r\n\r\n// Consommer et reconstruire \xe9tat\r\nconsumer.on('message', (message) => {\r\n  const event = JSON.parse(message.value);\r\n  projection.apply(event);\r\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-patterns-combin\xe9s",children:"\ud83c\udfa8 Patterns combin\xe9s"}),"\n",(0,s.jsx)(n.h3,{id:"event-sourcing--cqrs",children:"Event Sourcing + CQRS"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Write side"})," : Event Store"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Read side"})," : Projections optimis\xe9es (SQL, Elasticsearch, etc.)"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"// Write: Append event\r\nawait eventStore.append('order-123', new OrderPlacedEvent(...));\r\n\r\n// Read: Projection pr\xe9calcul\xe9e\r\nconst order = await readModel.getOrder('order-123'); // Instantan\xe9\n"})}),"\n",(0,s.jsx)(n.h3,{id:"event-sourcing--saga",children:"Event Sourcing + Saga"}),"\n",(0,s.jsx)(n.p,{children:"Les \xe9v\xe9nements d\xe9clenchent les \xe9tapes de saga"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-javascript",children:"eventBus.subscribe('OrderPlaced', async (event) => {\r\n  await saga.start(new ReserveInventorySagaStep(event.orderId));\r\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"-bonnes-pratiques",children:"\u2705 Bonnes pratiques"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\xc9v\xe9nements immuables"})," : jamais modifier un \xe9v\xe9nement publi\xe9"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"\xc9v\xe9nements m\xe9tier"})," : nommer selon le langage du domaine"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Idempotence"})," : supporter le replay sans effets de bord"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Versioning"})," : inclure version dans l'\xe9v\xe9nement"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Snapshots"})," : optimiser les reconstructions longues"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Projections asynchrones"})," : d\xe9coupler lecture/\xe9criture"]}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"-quand-utiliser-",children:"\ud83d\udcca Quand utiliser ?"}),"\n",(0,s.jsx)(n.h3,{id:"-cas-appropri\xe9s",children:"\u2705 Cas appropri\xe9s"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"Audit l\xe9gal obligatoire"}),"\n",(0,s.jsx)(n.li,{children:"Domaines complexes (finance, e-commerce)"}),"\n",(0,s.jsx)(n.li,{children:"Besoin d'historique complet"}),"\n",(0,s.jsx)(n.li,{children:"Analytics temporels"}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"-\xe9viter-si",children:"\u274c \xc9viter si"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:"CRUD simple suffit"}),"\n",(0,s.jsx)(n.li,{children:"\xc9quipe sans expertise"}),"\n",(0,s.jsx)(n.li,{children:"Contraintes de performance strictes"}),"\n",(0,s.jsx)(n.li,{children:"Donn\xe9es peu \xe9v\xe9nementielles"}),"\n"]}),"\n",(0,s.jsx)(n.h2,{id:"ressources",children:"Ressources"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://martinfowler.com/eaaDev/EventSourcing.html",children:"Event Sourcing - Martin Fowler"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.eventstore.com/",children:"EventStoreDB"})}),"\n",(0,s.jsx)(n.li,{children:(0,s.jsx)(n.a,{href:"https://www.amazon.com/Implementing-Domain-Driven-Design-Vaughn-Vernon/dp/0321834577",children:"Implementing Domain-Driven Design (Book)"})}),"\n"]})]})}function u(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(d,{...e})}):d(e)}},8453:(e,n,r)=>{r.d(n,{R:()=>a,x:()=>c});var t=r(6540);const s={},i=t.createContext(s);function a(e){const n=t.useContext(i);return t.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function c(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:a(e.components),t.createElement(i.Provider,{value:n},e.children)}}}]);