"use strict";(globalThis.webpackChunkdocusaurus_poc=globalThis.webpackChunkdocusaurus_poc||[]).push([[6957],{1094:(e,n,t)=>{t.r(n),t.d(n,{assets:()=>c,contentTitle:()=>a,default:()=>u,frontMatter:()=>i,metadata:()=>s,toc:()=>l});const s=JSON.parse('{"id":"devops/cicd/pipelines-drupal","title":"\ud83d\udd37 Pipeline Drupal - GitLab CI","description":"Pipeline CI/CD complet pour applications Drupal avec Composer sur GitLab CI.","source":"@site/docs/devops/cicd/pipelines-drupal.md","sourceDirName":"devops/cicd","slug":"/devops/cicd/pipelines-drupal","permalink":"/docs/devops/cicd/pipelines-drupal","draft":false,"unlisted":false,"editUrl":"https://github.com/facebook/docusaurus/tree/main/packages/create-docusaurus/templates/shared/docs/devops/cicd/pipelines-drupal.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2},"sidebar":"docs","previous":{"title":"\u2615 Pipeline Java/Maven - GitLab CI","permalink":"/docs/devops/cicd/pipelines-java"},"next":{"title":"\ud83d\udcc8 Prometheus & Grafana - Monitoring Complet","permalink":"/docs/devops/observability/prometheus-grafana"}}');var r=t(4848),o=t(8453);const i={sidebar_position:2},a="\ud83d\udd37 Pipeline Drupal - GitLab CI",c={},l=[{value:"\ud83c\udfaf Architecture du Pipeline GitLab CI Drupal",id:"-architecture-du-pipeline-gitlab-ci-drupal",level:2},{value:"\ud83d\udccb Pipeline GitLab CI Complet",id:"-pipeline-gitlab-ci-complet",level:2}];function p(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",mermaid:"mermaid",p:"p",pre:"pre",...(0,o.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"-pipeline-drupal---gitlab-ci",children:"\ud83d\udd37 Pipeline Drupal - GitLab CI"})}),"\n",(0,r.jsx)(n.p,{children:"Pipeline CI/CD complet pour applications Drupal avec Composer sur GitLab CI."}),"\n",(0,r.jsx)(n.h2,{id:"-architecture-du-pipeline-gitlab-ci-drupal",children:"\ud83c\udfaf Architecture du Pipeline GitLab CI Drupal"}),"\n",(0,r.jsx)(n.mermaid,{value:'graph LR\n    subgraph "Stages GitLab CI"\n        BUILD[\ud83d\udce6 Build]\n        QUALITY[\ud83d\udcca Quality]\n        TEST[\ud83e\uddea Test]\n        SECURITY[\ud83d\udd12 Security]\n        DOCKER[\ud83d\udc33 Docker]\n        DEPLOY_DEV[\ud83d\udd27 Deploy Dev]\n        DEPLOY_STAGING[\ud83c\udfad Deploy Staging]\n        DEPLOY_PROD[\ud83d\ude80 Deploy Prod]\n    end\n    \n    BUILD --\x3e QUALITY\n    QUALITY --\x3e TEST\n    TEST --\x3e SECURITY\n    SECURITY --\x3e DOCKER\n    DOCKER --\x3e DEPLOY_DEV\n    DEPLOY_DEV --\x3e DEPLOY_STAGING\n    DEPLOY_STAGING --\x3e DEPLOY_PROD\n    \n    subgraph "Outils"\n        COMPOSER[\ud83d\udce6 Composer]\n        PHPCS[\ud83d\udccb PHPCS]\n        PHPSTAN[\ud83d\udd0d PHPStan]\n        PHPUNIT[\ud83e\uddea PHPUnit]\n        BEHAT[\ud83c\udfaf Behat]\n        TRIVY[\ud83d\udd0d Trivy]\n        DRUSH[\ud83d\udd27 Drush]\n    end\n    \n    BUILD --\x3e COMPOSER\n    QUALITY --\x3e PHPCS\n    QUALITY --\x3e PHPSTAN\n    TEST --\x3e PHPUNIT\n    TEST --\x3e BEHAT\n    SECURITY --\x3e TRIVY\n    DEPLOY_PROD --\x3e DRUSH'}),"\n",(0,r.jsx)(n.h2,{id:"-pipeline-gitlab-ci-complet",children:"\ud83d\udccb Pipeline GitLab CI Complet"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-yaml",metastring:'title=".gitlab-ci.yml"',children:'# GitLab CI Pipeline pour Drupal 10\n# Version: 1.0\n# Description: Pipeline DevSecOps complet pour Drupal\n\nvariables:\n  # PHP\n  PHP_VERSION: "8.2"\n  \n  # Composer\n  COMPOSER_CACHE_DIR: "${CI_PROJECT_DIR}/.composer-cache"\n  COMPOSER_ALLOW_SUPERUSER: "1"\n  COMPOSER_MEMORY_LIMIT: "-1"\n  \n  # Docker\n  DOCKER_DRIVER: overlay2\n  DOCKER_TLS_CERTDIR: "/certs"\n  REGISTRY: $CI_REGISTRY\n  IMAGE_NAME: $CI_REGISTRY_IMAGE\n  \n  # Application\n  APP_NAME: "my-drupal-site"\n  DRUPAL_ROOT: "/var/www/html/web"\n  \n  # Database\n  MYSQL_ROOT_PASSWORD: "root"\n  MYSQL_DATABASE: "drupal"\n  MYSQL_USER: "drupal"\n  MYSQL_PASSWORD: "drupal"\n  \n  # Kubernetes\n  KUBE_NAMESPACE_DEV: "dev"\n  KUBE_NAMESPACE_STAGING: "staging"\n  KUBE_NAMESPACE_PROD: "production"\n\n# Cache Composer\ncache:\n  key: ${CI_COMMIT_REF_SLUG}\n  paths:\n    - .composer-cache/\n    - vendor/\n    - web/core/\n    - web/modules/contrib/\n    - web/themes/contrib/\n\n# Stages\nstages:\n  - build\n  - quality\n  - test\n  - security\n  - package\n  - deploy-dev\n  - deploy-staging\n  - deploy-prod\n\n# Templates\n.php_template: &php_template\n  image: php:${PHP_VERSION}-cli\n  before_script:\n    - apt-get update -qq\n    - apt-get install -y -qq git unzip libzip-dev libpng-dev libpq-dev libicu-dev\n    - docker-php-ext-install zip gd pdo pdo_mysql intl\n    - curl -sS https://getcomposer.org/installer | php -- --install-dir=/usr/local/bin --filename=composer\n    - composer --version\n    - php --version\n\n.docker_template: &docker_template\n  image: docker:24-dind\n  services:\n    - docker:24-dind\n  before_script:\n    - docker info\n    - echo "$CI_REGISTRY_PASSWORD" | docker login -u "$CI_REGISTRY_USER" --password-stdin $CI_REGISTRY\n\n# ============================================\n# Stage 1: BUILD\n# ============================================\nbuild:composer:\n  <<: *php_template\n  stage: build\n  script:\n    - echo "\ud83d\udce6 Installing dependencies with Composer..."\n    - composer validate --no-check-all --strict\n    - composer install --prefer-dist --no-progress --no-interaction --optimize-autoloader\n    - echo "\u2705 Dependencies installed"\n    - ls -la vendor/\n  artifacts:\n    paths:\n      - vendor/\n      - web/core/\n      - web/modules/contrib/\n      - web/themes/contrib/\n      - composer.lock\n    expire_in: 1 hour\n  only:\n    - branches\n    - merge_requests\n\n# ============================================\n# Stage 2: QUALITY\n# ============================================\nquality:phpcs:\n  <<: *php_template\n  stage: quality\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udccb Running PHP Code Sniffer..."\n    - ./vendor/bin/phpcs --standard=Drupal --extensions=php,module,inc,install,test,profile,theme,css,info,txt,md,yml\n        --report=full\n        --report-file=phpcs-report.txt\n        web/modules/custom/ web/themes/custom/ || true\n    - ./vendor/bin/phpcs --standard=DrupalPractice --extensions=php,module,inc,install,test,profile,theme\n        --report=full\n        --report-file=phpcs-practice-report.txt\n        web/modules/custom/ web/themes/custom/ || true\n    - cat phpcs-report.txt\n    - cat phpcs-practice-report.txt\n  artifacts:\n    when: always\n    paths:\n      - phpcs-report.txt\n      - phpcs-practice-report.txt\n    expire_in: 1 week\n  allow_failure: true\n  only:\n    - branches\n    - merge_requests\n\nquality:phpstan:\n  <<: *php_template\n  stage: quality\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udd0d Running PHPStan static analysis..."\n    - ./vendor/bin/phpstan analyse web/modules/custom/ web/themes/custom/\n        --level=6\n        --error-format=table\n        --no-progress\n        --memory-limit=1G || true\n  artifacts:\n    when: always\n    paths:\n      - phpstan-report.txt\n    expire_in: 1 week\n  allow_failure: true\n  only:\n    - branches\n    - merge_requests\n\nquality:phpmd:\n  <<: *php_template\n  stage: quality\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udcca Running PHP Mess Detector..."\n    - ./vendor/bin/phpmd web/modules/custom/,web/themes/custom/\n        text\n        cleancode,codesize,controversial,design,naming,unusedcode || true\n  allow_failure: true\n  only:\n    - branches\n    - merge_requests\n\nquality:phpcpd:\n  <<: *php_template\n  stage: quality\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udd0d Running PHP Copy/Paste Detector..."\n    - ./vendor/bin/phpcpd web/modules/custom/ web/themes/custom/ || true\n  allow_failure: true\n  only:\n    - branches\n    - merge_requests\n\nquality:sonarqube:\n  image: sonarsource/sonar-scanner-cli:latest\n  stage: quality\n  dependencies:\n    - build:composer\n    - test:phpunit\n  variables:\n    SONAR_USER_HOME: "${CI_PROJECT_DIR}/.sonar"\n    GIT_DEPTH: "0"\n  cache:\n    key: "${CI_JOB_NAME}"\n    paths:\n      - .sonar/cache\n  script:\n    - echo "\ud83d\udcca Running SonarQube analysis..."\n    - sonar-scanner\n        -Dsonar.projectKey=$CI_PROJECT_PATH_SLUG\n        -Dsonar.projectName="$CI_PROJECT_NAME"\n        -Dsonar.sources=web/modules/custom,web/themes/custom\n        -Dsonar.host.url=$SONAR_HOST_URL\n        -Dsonar.login=$SONAR_TOKEN\n        -Dsonar.php.coverage.reportPaths=coverage/clover.xml\n        -Dsonar.qualitygate.wait=true\n  allow_failure: true\n  only:\n    - branches\n    - merge_requests\n\n# ============================================\n# Stage 3: TEST\n# ============================================\ntest:phpunit:\n  <<: *php_template\n  stage: test\n  services:\n    - name: mysql:8.0\n      alias: mysql\n      command: ["--default-authentication-plugin=mysql_native_password"]\n  dependencies:\n    - build:composer\n  variables:\n    SIMPLETEST_BASE_URL: "http://localhost:8080"\n    SIMPLETEST_DB: "mysql://drupal:drupal@mysql:3306/drupal"\n    MINK_DRIVER_ARGS_WEBDRIVER: \'["chrome", {"browserName":"chrome","chromeOptions":{"args":["--disable-gpu","--headless"]}}, "http://localhost:4444"]\'\n  script:\n    - echo "\ud83e\uddea Running PHPUnit tests..."\n    - |\n      # Start PHP built-in server\n      php -S localhost:8080 -t web &\n      PHP_PID=$!\n    - sleep 5\n    - |\n      # Run PHPUnit tests\n      ./vendor/bin/phpunit\n        --configuration=web/core/phpunit.xml.dist\n        --testsuite=unit\n        --coverage-clover=coverage/clover.xml\n        --coverage-html=coverage/html\n        --log-junit=junit.xml\n        web/modules/custom/ || true\n    - kill $PHP_PID || true\n  artifacts:\n    when: always\n    reports:\n      junit: junit.xml\n      coverage_report:\n        coverage_format: cobertura\n        path: coverage/clover.xml\n    paths:\n      - coverage/\n      - junit.xml\n    expire_in: 1 week\n  coverage: \'/^\\s*Lines:\\s*\\d+\\.\\d+\\%/\'\n  only:\n    - branches\n    - merge_requests\n\ntest:behat:\n  <<: *php_template\n  stage: test\n  services:\n    - name: mysql:8.0\n      alias: mysql\n      command: ["--default-authentication-plugin=mysql_native_password"]\n    - name: selenium/standalone-chrome:latest\n      alias: selenium\n  dependencies:\n    - build:composer\n  variables:\n    BEHAT_PARAMS: \'{"extensions":{"Behat\\\\MinkExtension":{"base_url":"http://localhost:8080"},"Drupal\\\\DrupalExtension":{"drupal":{"drupal_root":"web"},"drush":{"root":"web"}}}}\'\n  script:\n    - echo "\ud83c\udfaf Running Behat tests..."\n    - |\n      # Install Drupal for testing\n      cd web\n      ../vendor/bin/drush site:install standard\n        --db-url=mysql://drupal:drupal@mysql:3306/drupal\n        --site-name="Test Site"\n        --account-name=admin\n        --account-pass=admin\n        --yes\n      cd ..\n    - |\n      # Start PHP server\n      php -S localhost:8080 -t web &\n      PHP_PID=$!\n    - sleep 10\n    - |\n      # Run Behat\n      ./vendor/bin/behat --format=pretty --out=std --format=junit --out=behat-results || true\n    - kill $PHP_PID || true\n  artifacts:\n    when: always\n    paths:\n      - behat-results/\n    expire_in: 1 week\n  allow_failure: true\n  only:\n    - branches\n    - merge_requests\n\n# ============================================\n# Stage 4: SECURITY\n# ============================================\nsecurity:drupal-check:\n  <<: *php_template\n  stage: security\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udd10 Checking Drupal security advisories..."\n    - |\n      cd web\n      ../vendor/bin/drush pm:security --format=json > ../security-report.json || true\n      cat ../security-report.json\n    - |\n      # Check if there are any security issues\n      SECURITY_COUNT=$(cat ../security-report.json | grep -c "\\"is_security\\":true" || echo "0")\n      if [ "$SECURITY_COUNT" -gt "0" ]; then\n        echo "\u274c Found $SECURITY_COUNT security advisories!"\n        cat ../security-report.json\n        exit 1\n      else\n        echo "\u2705 No security advisories found"\n      fi\n  artifacts:\n    when: always\n    paths:\n      - security-report.json\n    expire_in: 1 week\n  allow_failure: false\n  only:\n    - branches\n    - merge_requests\n\nsecurity:composer-audit:\n  <<: *php_template\n  stage: security\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udd0d Running Composer audit..."\n    - composer audit --format=json > composer-audit.json || true\n    - composer audit --format=table || true\n  artifacts:\n    when: always\n    paths:\n      - composer-audit.json\n    expire_in: 1 week\n  allow_failure: false\n  only:\n    - branches\n    - merge_requests\n\nsecurity:trivy-fs:\n  image: aquasec/trivy:latest\n  stage: security\n  script:\n    - echo "\ud83d\udd0d Scanning filesystem with Trivy..."\n    - trivy fs --security-checks vuln,secret,config\n        --severity CRITICAL,HIGH\n        --format json\n        --output trivy-fs-report.json\n        .\n    - trivy fs --security-checks vuln,secret,config\n        --severity CRITICAL,HIGH\n        --format template\n        --template "@/contrib/html.tpl"\n        --output trivy-fs-report.html\n        .\n  artifacts:\n    when: always\n    paths:\n      - trivy-fs-report.json\n      - trivy-fs-report.html\n    reports:\n      container_scanning: trivy-fs-report.json\n    expire_in: 1 week\n  allow_failure: false\n  only:\n    - branches\n    - merge_requests\n\nsecurity:gitleaks:\n  image: zricethezav/gitleaks:latest\n  stage: security\n  script:\n    - echo "\ud83d\udd10 Scanning for secrets with Gitleaks..."\n    - gitleaks detect --source . --report-format json --report-path gitleaks-report.json --verbose\n  artifacts:\n    when: always\n    paths:\n      - gitleaks-report.json\n    expire_in: 1 week\n  allow_failure: false\n  only:\n    - branches\n    - merge_requests\n\nsecurity:sbom-generate:\n  <<: *php_template\n  stage: security\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udccb Generating SBOM with CycloneDX..."\n    - ./vendor/bin/cyclonedx-php composer\n        --output-format=json\n        --output-file=sbom-cyclonedx.json\n    - ./vendor/bin/cyclonedx-php composer\n        --output-format=xml\n        --output-file=sbom-cyclonedx.xml\n    - echo "\ud83d\udccb Generating SBOM with Syft..."\n    - curl -sSfL https://raw.githubusercontent.com/anchore/syft/main/install.sh | sh -s -- -b /usr/local/bin\n    - syft packages dir:. -o cyclonedx-json=sbom-syft.json\n    - syft packages dir:. -o spdx-json=sbom-spdx.json\n  artifacts:\n    paths:\n      - sbom-cyclonedx.json\n      - sbom-cyclonedx.xml\n      - sbom-syft.json\n      - sbom-spdx.json\n    expire_in: 1 month\n  only:\n    - branches\n    - merge_requests\n\nsecurity:sbom-scan:\n  image: anchore/grype:latest\n  stage: security\n  dependencies:\n    - security:sbom-generate\n  script:\n    - echo "\ud83d\udd0d Scanning SBOM with Grype..."\n    - grype sbom:sbom-syft.json -o json --file grype-report.json\n    - grype sbom:sbom-syft.json -o table\n    - |\n      CRITICAL=$(cat grype-report.json | jq \'[.matches[] | select(.vulnerability.severity=="Critical")] | length\')\n      HIGH=$(cat grype-report.json | jq \'[.matches[] | select(.vulnerability.severity=="High")] | length\')\n      echo "Critical: $CRITICAL, High: $HIGH"\n      if [ "$CRITICAL" -gt "0" ]; then\n        echo "\u274c Critical vulnerabilities found!"\n        exit 1\n      fi\n  artifacts:\n    when: always\n    paths:\n      - grype-report.json\n    expire_in: 1 week\n  allow_failure: false\n  only:\n    - branches\n    - merge_requests\n\n# ============================================\n# Stage 5: PACKAGE\n# ============================================\npackage:docker:\n  <<: *docker_template\n  stage: package\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udc33 Building Docker image..."\n    - |\n      if [ "$CI_COMMIT_TAG" != "" ]; then\n        TAG="$CI_COMMIT_TAG"\n      else\n        TAG="$CI_COMMIT_SHORT_SHA"\n      fi\n    - echo "Tag: $TAG"\n    - docker build -t $IMAGE_NAME:$TAG -t $IMAGE_NAME:latest .\n    - echo "\ud83d\udd0d Scanning image with Trivy..."\n    - docker run --rm -v /var/run/docker.sock:/var/run/docker.sock aquasec/trivy:latest image\n        --severity CRITICAL,HIGH\n        --exit-code 1\n        --no-progress\n        $IMAGE_NAME:$TAG\n    - echo "\u270d\ufe0f Signing image with Cosign..."\n    - apk add --no-cache cosign\n    - echo "$COSIGN_PRIVATE_KEY" > cosign.key\n    - cosign sign --key cosign.key --yes $IMAGE_NAME:$TAG\n    - rm cosign.key\n    - echo "\ud83d\udce4 Pushing image..."\n    - docker push $IMAGE_NAME:$TAG\n    - docker push $IMAGE_NAME:latest\n    - echo "\u2705 Docker image pushed: $IMAGE_NAME:$TAG"\n  only:\n    - branches\n    - merge_requests\n    - tags\n\n# ============================================\n# Stage 6: DEPLOY DEV\n# ============================================\ndeploy:dev:\n  image: bitnami/kubectl:latest\n  stage: deploy-dev\n  environment:\n    name: development\n    url: https://dev.example.com\n    on_stop: stop:dev\n  script:\n    - echo "\ud83d\ude80 Deploying to Development..."\n    - kubectl config use-context $KUBE_CONTEXT_DEV\n    - |\n      if [ "$CI_COMMIT_TAG" != "" ]; then\n        TAG="$CI_COMMIT_TAG"\n      else\n        TAG="$CI_COMMIT_SHORT_SHA"\n      fi\n    - kubectl set image deployment/$APP_NAME\n        $APP_NAME=$IMAGE_NAME:$TAG\n        -n $KUBE_NAMESPACE_DEV\n    - kubectl rollout status deployment/$APP_NAME -n $KUBE_NAMESPACE_DEV --timeout=5m\n    - echo "\ud83d\udd27 Running Drush commands..."\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_DEV -- drush updatedb --yes\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_DEV -- drush config:import --yes\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_DEV -- drush cache:rebuild\n    - echo "\u2705 Deployment to Dev successful"\n  only:\n    - branches\n    - merge_requests\n  except:\n    - tags\n\nstop:dev:\n  image: bitnami/kubectl:latest\n  stage: deploy-dev\n  environment:\n    name: development\n    action: stop\n  script:\n    - echo "\ud83d\uded1 Stopping Development environment..."\n    - kubectl scale deployment/$APP_NAME --replicas=0 -n $KUBE_NAMESPACE_DEV\n  when: manual\n  only:\n    - branches\n\n# ============================================\n# Stage 7: DEPLOY STAGING\n# ============================================\ndeploy:staging:\n  image: bitnami/kubectl:latest\n  stage: deploy-staging\n  environment:\n    name: staging\n    url: https://staging.example.com\n  script:\n    - echo "\ud83d\ude80 Deploying to Staging..."\n    - kubectl config use-context $KUBE_CONTEXT_STAGING\n    - TAG="$CI_COMMIT_SHORT_SHA"\n    - kubectl set image deployment/$APP_NAME\n        $APP_NAME=$IMAGE_NAME:$TAG\n        -n $KUBE_NAMESPACE_STAGING\n    - kubectl rollout status deployment/$APP_NAME -n $KUBE_NAMESPACE_STAGING --timeout=5m\n    - echo "\ud83d\udd27 Running Drush commands..."\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_STAGING -- drush updatedb --yes\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_STAGING -- drush config:import --yes\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_STAGING -- drush cache:rebuild\n    - echo "\u2705 Deployment to Staging successful"\n  only:\n    - main\n    - develop\n  when: manual\n\n# ============================================\n# Stage 8: DEPLOY PRODUCTION\n# ============================================\ndeploy:production:\n  image: bitnami/kubectl:latest\n  stage: deploy-prod\n  environment:\n    name: production\n    url: https://www.example.com\n  script:\n    - echo "\ud83d\ude80 Deploying to Production..."\n    - kubectl config use-context $KUBE_CONTEXT_PROD\n    - |\n      if [ "$CI_COMMIT_TAG" != "" ]; then\n        TAG="$CI_COMMIT_TAG"\n      else\n        echo "\u274c Production deployment requires a tag"\n        exit 1\n      fi\n    - echo "Deploying version: $TAG"\n    - echo "\ud83d\udd04 Enabling maintenance mode..."\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_PROD -- drush state:set system.maintenance_mode 1 --yes || true\n    - kubectl set image deployment/$APP_NAME\n        $APP_NAME=$IMAGE_NAME:$TAG\n        -n $KUBE_NAMESPACE_PROD\n    - kubectl rollout status deployment/$APP_NAME -n $KUBE_NAMESPACE_PROD --timeout=10m\n    - echo "\ud83d\udd27 Running Drush commands..."\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_PROD -- drush updatedb --yes\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_PROD -- drush config:import --yes\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_PROD -- drush cache:rebuild\n    - echo "\ud83d\udd04 Disabling maintenance mode..."\n    - kubectl exec deployment/$APP_NAME -n $KUBE_NAMESPACE_PROD -- drush state:set system.maintenance_mode 0 --yes\n    - echo "\u2705 Deployment to Production successful"\n    - echo "\ud83e\uddea Running smoke tests..."\n    - sleep 30\n    - kubectl run curl-test --rm -i --restart=Never --image=curlimages/curl:latest\n        -n $KUBE_NAMESPACE_PROD\n        -- curl -f https://www.example.com || exit 1\n  only:\n    - tags\n  when: manual\n\n# ============================================\n# Scheduled Jobs\n# ============================================\nsecurity:scheduled-scan:\n  <<: *php_template\n  stage: security\n  dependencies:\n    - build:composer\n  script:\n    - echo "\ud83d\udd0d Running scheduled security scan..."\n    - cd web\n    - ../vendor/bin/drush pm:security --format=json > ../scheduled-security.json\n    - cat ../scheduled-security.json\n  artifacts:\n    when: always\n    paths:\n      - scheduled-security.json\n    expire_in: 1 month\n  only:\n    - schedules\n'})})]})}function u(e={}){const{wrapper:n}={...(0,o.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(p,{...e})}):p(e)}},8453:(e,n,t)=>{t.d(n,{R:()=>i,x:()=>a});var s=t(6540);const r={},o=s.createContext(r);function i(e){const n=s.useContext(o);return s.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:i(e.components),s.createElement(o.Provider,{value:n},e.children)}}}]);