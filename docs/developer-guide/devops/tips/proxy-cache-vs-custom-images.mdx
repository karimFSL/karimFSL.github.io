---
sidebar_position: 5
title: Proxy Cache vs Images Personnalis√©es
description: Comprendre les diff√©rences entre utiliser un proxy cache Harbor et maintenir ses propres images de base
keywords: [harbor, docker, registry, proxy cache, images personnalis√©es]
---

# Proxy Cache vs Images Personnalis√©es sur Harbor

## Introduction

Lorsque vous g√©rez un registre Harbor, vous avez deux strat√©gies principales pour acc√©der aux images de conteneurs publiques :

1. **Proxy Cache** : Configurer Harbor comme cache interm√©diaire vers des registries publics
2. **Images Personnalis√©es** : Cr√©er et maintenir vos propres images dans un projet Harbor public

Ce guide vous aide √† comprendre les diff√©rences et √† choisir l'approche adapt√©e √† vos besoins.

## Qu'est-ce qu'un Proxy Cache ?

### Concept

Un proxy cache Harbor agit comme un miroir intelligent entre vos utilisateurs et les registries publics (Docker Hub, Quay.io, gcr.io, etc.).

```mermaid
graph LR
    A[D√©veloppeur] -->|docker pull| B[Harbor Proxy Cache]
    B -->|Cache Miss| C[Docker Hub]
    B -->|Cache Hit| B
    C -->|Image| B
    B -->|Image| A
```

### Configuration dans Harbor

1. Cr√©ez un nouveau projet de type "Proxy Cache"
2. Configurez l'URL du registry source (ex: `https://hub.docker.com`)
3. Utilisez le proxy dans vos pulls :

```bash
# Au lieu de :
docker pull nginx:latest

# Utilisez :
docker pull harbor.votredomaine.com/dockerhub-proxy/nginx:latest
```

### Avantages ‚úÖ

- **Z√©ro maintenance** : Les images restent identiques aux originales
- **√âconomie de bande passante** : Une seule r√©cup√©ration depuis Internet pour toute l'√©quipe
- **Contournement des rate limits** : √âvite les restrictions Docker Hub (100 pulls/6h en mode anonyme)
- **Disponibilit√© accrue** : Continue de servir les images m√™me si Docker Hub est down
- **Transparence** : Aucune modification des images, tra√ßabilit√© compl√®te

### Inconv√©nients ‚ùå

- **Aucune personnalisation possible** : Vous ne pouvez pas modifier les images
- **D√©pendance upstream** : Si l'image est supprim√©e du registry source, elle dispara√Ætra du cache
- **Pas de contr√¥le sur le contenu** : Vous h√©ritez des vuln√©rabilit√©s de l'image source

## Images Personnalis√©es dans un Projet Public

### Concept

Vous cr√©ez vos propres images (bas√©es ou non sur des images publiques) et les stockez dans votre projet Harbor public.

```dockerfile
# Dockerfile
FROM nginx:1.25-alpine

# Personnalisations
RUN apk add --no-cache curl vim && \
    rm -rf /var/cache/apk/*

# Configuration custom
COPY nginx.conf /etc/nginx/nginx.conf
COPY ssl/ /etc/nginx/ssl/

# Labels pour la tra√ßabilit√©
LABEL maintainer="votre-equipe@votredomaine.com" \
      version="1.0.0" \
      description="Nginx personnalis√© avec config entreprise"

EXPOSE 80 443
```

### Pipeline CI/CD

```yaml
# .gitlab-ci.yml ou GitHub Actions
build-and-push:
  stage: build
  script:
    - docker login harbor.votredomaine.com -u $HARBOR_USER -p $HARBOR_PASSWORD
    - docker build -t harbor.votredomaine.com/myproject/nginx-custom:${CI_COMMIT_TAG} .
    - docker push harbor.votredomaine.com/myproject/nginx-custom:${CI_COMMIT_TAG}
    - docker tag harbor.votredomaine.com/myproject/nginx-custom:${CI_COMMIT_TAG} \
                 harbor.votredomaine.com/myproject/nginx-custom:latest
    - docker push harbor.votredomaine.com/myproject/nginx-custom:latest
```

### Avantages ‚úÖ

- **Contr√¥le total** : Vous d√©cidez exactement ce qui est dans l'image
- **Personnalisation** : Ajout d'outils, configurations, certificats, etc.
- **S√©curit√© renforc√©e** : Vous pouvez patcher les vuln√©rabilit√©s imm√©diatement
- **Immuabilit√© garantie** : Les versions ne changent jamais, aucun risque de suppression
- **Compliance** : Respect des politiques de s√©curit√© de l'entreprise
- **Optimisation** : Suppression des composants inutiles, r√©duction de la taille

### Inconv√©nients ‚ùå

- **Maintenance continue** : Vous devez rebuilder pour les updates de s√©curit√©
- **Stockage** : Consomme l'espace disque de Harbor
- **Effort initial** : Setup des pipelines CI/CD et Dockerfiles
- **Responsabilit√©** : Vous √™tes responsable des vuln√©rabilit√©s et bugs

## Tableau Comparatif

| Crit√®re | Proxy Cache | Images Personnalis√©es |
|---------|-------------|----------------------|
| **Maintenance** | üü¢ Aucune | üî¥ √âlev√©e (rebuilds r√©guliers) |
| **Personnalisation** | üî¥ Impossible | üü¢ Totale |
| **Stockage Harbor** | üü° Mod√©r√© (cache) | üî¥ √âlev√© (versions multiples) |
| **S√©curit√©** | üü° D√©pend de l'upstream | üü¢ Sous votre contr√¥le |
| **Temps de setup** | üü¢ 5 minutes | üî¥ Plusieurs heures |
| **Rate limiting** | üü¢ Contourn√© | üü¢ N/A |
| **Tra√ßabilit√©** | üü¢ Parfaite | üü¢ Parfaite |
| **Disponibilit√©** | üü¢ Haute | üü¢ Totale |

## Quand Utiliser Chaque Approche ?

### Utilisez un Proxy Cache pour üì¶

- Images officielles utilis√©es sans modification
  - `redis`, `postgres`, `nginx`, `alpine`
- Images de build temporaires
  - `node:18`, `golang:1.21`, `maven:3.9`
- Services tiers standards
  - `grafana/grafana`, `prom/prometheus`
- Environnements de d√©veloppement

**Exemple d'usage :**

```yaml
# docker-compose.yml
services:
  database:
    image: harbor.votredomaine.com/dockerhub-proxy/postgres:15-alpine
    
  cache:
    image: harbor.votredomaine.com/dockerhub-proxy/redis:7-alpine
    
  monitoring:
    image: harbor.votredomaine.com/quay-proxy/prometheus/prometheus:v2.45.0
```

### Utilisez des Images Personnalis√©es pour üîß

- Applications avec configurations sp√©cifiques
- Images n√©cessitant des outils additionnels
- Environnements de production critiques
- Besoins de s√©curit√© renforc√©s
- Images devant respecter des standards internes
- Optimisation des tailles d'images

**Exemple d'usage :**

```yaml
# docker-compose.yml
services:
  frontend:
    image: harbor.votredomaine.com/myproject/frontend:2.1.0
    # Image custom avec Nginx + configs SSL + headers s√©curit√©
    
  backend:
    image: harbor.votredomaine.com/myproject/backend:2.1.0
    # Image custom avec Node.js + outils monitoring + certificats
```

## Strat√©gie Hybride Recommand√©e üéØ

La meilleure approche combine les deux strat√©gies :

```yaml
version: '3.8'

services:
  # ===== PROXY CACHE : Images standards =====
  postgres:
    image: harbor.votredomaine.com/dockerhub-proxy/postgres:15-alpine
    # Pas de modification n√©cessaire
    
  redis:
    image: harbor.votredomaine.com/dockerhub-proxy/redis:7-alpine
    # Utilis√© tel quel
    
  # ===== IMAGES CUSTOM : Applications m√©tier =====
  api:
    image: harbor.votredomaine.com/myproject/api:${VERSION}
    # Build√©e depuis node:18-alpine (via proxy cache)
    # + code m√©tier + configs + optimisations
    
  web:
    image: harbor.votredomaine.com/myproject/web:${VERSION}
    # Build√©e depuis nginx:alpine (via proxy cache)
    # + frontend build + SSL + headers s√©curit√©
    
  # ===== IMAGE CUSTOM : Base partag√©e =====
  worker:
    image: harbor.votredomaine.com/myproject/python-base:3.11
    # Image de base partag√©e pour tous les workers Python
    # Inclut : libs communes, outils monitoring, certificats CA
```

## Bonnes Pratiques

### Pour le Proxy Cache

```bash
# 1. Cr√©ez des projets proxy s√©par√©s par source
harbor.votredomaine.com/dockerhub-proxy/
harbor.votredomaine.com/quay-proxy/
harbor.votredomaine.com/gcr-proxy/

# 2. Configurez la r√©tention du cache
# Dans Harbor UI : Projects ‚Üí Policy ‚Üí Retention

# 3. Utilisez des tags explicites (√©vitez :latest en prod)
docker pull harbor.votredomaine.com/dockerhub-proxy/nginx:1.25-alpine
```

### Pour les Images Personnalis√©es

```dockerfile
# 1. Multi-stage builds pour r√©duire la taille
FROM harbor.votredomaine.com/dockerhub-proxy/node:18 AS builder
WORKDIR /app
COPY package*.json ./
RUN npm ci --production
COPY . .
RUN npm run build

FROM harbor.votredomaine.com/dockerhub-proxy/nginx:alpine
COPY --from=builder /app/dist /usr/share/nginx/html

# 2. Utilisez des images de base du proxy cache
FROM harbor.votredomaine.com/dockerhub-proxy/alpine:3.18

# 3. Versionnez explicitement
LABEL version="2.1.0" \
      build-date="2024-01-15" \
      commit-sha="${GIT_COMMIT}"

# 4. Scannez les vuln√©rabilit√©s
# Harbor int√©gr√© avec Trivy/Clair
```

## Workflow Complet

```mermaid
graph TD
    A[Besoin d'une image] --> B{Personnalisation requise ?}
    B -->|Non| C[Utiliser Proxy Cache]
    B -->|Oui| D[Cr√©er Image Custom]
    
    C --> E[docker pull harbor.com/proxy/image:tag]
    
    D --> F[FROM harbor.com/proxy/base:tag]
    F --> G[Ajouter customisations]
    G --> H[Build + Push vers projet public]
    H --> I[Scanner vuln√©rabilit√©s]
    I --> J{Vuln√©rabilit√©s critiques ?}
    J -->|Oui| K[Corriger et rebuild]
    J -->|Non| L[D√©ployer]
    K --> I
    
    E --> M[Utiliser en prod]
    L --> M
```

## Conclusion

Le choix entre proxy cache et images personnalis√©es n'est pas binaire. Une architecture moderne utilise :

- **Proxy cache** pour 70-80% des images (base de donn√©es, outils, services standards)
- **Images personnalis√©es** pour 20-30% (applications m√©tier, images avec besoins sp√©cifiques)

Cette approche optimise le rapport effort/b√©n√©fice tout en maintenant flexibilit√© et contr√¥le.

:::tip Conseil
Commencez par le proxy cache pour toutes vos images, puis cr√©ez des images personnalis√©es uniquement quand un besoin sp√©cifique se pr√©sente.
:::

:::warning Attention
En production, √©vitez le tag `:latest` m√™me avec un proxy cache. Utilisez toujours des versions explicites pour garantir la reproductibilit√©.
:::