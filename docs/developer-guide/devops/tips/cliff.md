---
sidebar_position: 5
---

# G√©n√©ration automatique de Changelog avec git-cliff

## Introduction

**git-cliff** est un g√©n√©rateur de changelog rapide et configurable qui g√©n√®re automatiquement des changelogs √† partir de l'historique Git en suivant les conventions Conventional Commits.

**Pourquoi git-cliff ?**
- üöÄ Ultra-rapide (√©crit en Rust)
- üìù Support des Conventional Commits
- üé® Hautement personnalisable
- üîß Int√©gration facile CI/CD

---

## Installation rapide
```bash
# Linux/macOS
cargo install git-cliff

# Ou t√©l√©chargement direct
curl -L https://github.com/orhun/git-cliff/releases/latest/download/git-cliff-x86_64-unknown-linux-gnu.tar.gz | tar xz
sudo mv git-cliff /usr/local/bin/

# V√©rification
git-cliff --version
```

---

## Configuration de base

Cr√©ez `cliff.toml` √† la racine de votre projet :
```toml
[changelog]
header = """
# Changelog\n
Le format est bas√© sur [Keep a Changelog](https://keepachangelog.com/fr/1.0.0/).\n
"""

body = """
{% if version %}\
    ## [{{ version | trim_start_matches(pat="v") }}] - {{ timestamp | date(format="%Y-%m-%d") }}
{% else %}\
    ## [Non publi√©]
{% endif %}\
{% for group, commits in commits | group_by(attribute="group") %}
    ### {{ group }}
    {% for commit in commits %}
        - {{ commit.message | upper_first }}{% if commit.breaking %} [**BREAKING**]{% endif %}\
    {% endfor %}
{% endfor %}\n
"""

footer = """
<!-- generated by git-cliff -->
"""

[git]
conventional_commits = true
filter_unconventional = true

commit_parsers = [
    { message = "^feat", group = "‚ú® Nouvelles fonctionnalit√©s" },
    { message = "^fix", group = "üêõ Corrections de bugs" },
    { message = "^doc", group = "üìö Documentation" },
    { message = "^perf", group = "‚ö° Performance" },
    { message = "^refactor", group = "‚ôªÔ∏è Refactoring" },
    { message = "^test", group = "‚úÖ Tests" },
    { message = "^chore\\(release\\)", skip = true },
    { message = "^chore", group = "üîß Maintenance" },
]

# Liens vers GitLab
commit_preprocessors = [
    { pattern = '\(#([0-9]+)\)', replace = "([#${1}](https://gitlab.com/votre-org/votre-repo/-/issues/${1}))" },
    { pattern = '\(!([0-9]+)\)', replace = "([!${1}](https://gitlab.com/votre-org/votre-repo/-/merge_requests/${1}))" },
]

sort_commits = "oldest"
```

---

## Utilisation quotidienne

### Commandes essentielles
```bash
# Voir les changements non publi√©s
git-cliff --unreleased

# G√©n√©rer le changelog complet
git-cliff -o CHANGELOG.md

# G√©n√©rer pour une nouvelle version
git-cliff --tag v1.2.0 -o CHANGELOG.md

# Pr√©visualiser avec une future version
git-cliff --unreleased --tag v1.2.0
```

---

## Int√©gration GitLab CI

Cr√©ez `.gitlab-ci.yml` :
```yaml
stages:
  - release

variables:
  GIT_DEPTH: 0  # Important pour l'historique complet

generate-changelog:
  stage: release
  image: rust:alpine
  only:
    - tags
    - /^v\d+\.\d+\.\d+$/
  before_script:
    - apk add --no-cache git curl
    - |
      curl -L https://github.com/orhun/git-cliff/releases/latest/download/git-cliff-x86_64-unknown-linux-musl.tar.gz | tar xz
      mv git-cliff /usr/local/bin/
      chmod +x /usr/local/bin/git-cliff
  script:
    - echo "üöÄ G√©n√©ration du changelog pour $CI_COMMIT_TAG"
    - git-cliff --latest --output CHANGELOG.md
    - |
      # Commit et push du changelog
      git config user.name "GitLab CI"
      git config user.email "ci@gitlab.com"
      git add CHANGELOG.md
      git commit -m "docs: update CHANGELOG.md for $CI_COMMIT_TAG [skip ci]" || true
      git remote set-url origin https://oauth2:${CI_JOB_TOKEN}@${CI_SERVER_HOST}/${CI_PROJECT_PATH}.git
      git push origin HEAD:main -o ci.skip || true
  artifacts:
    paths:
      - CHANGELOG.md
    expire_in: 1 month

create-release:
  stage: release
  image: registry.gitlab.com/gitlab-org/release-cli:latest
  needs:
    - generate-changelog
  only:
    - tags
    - /^v\d+\.\d+\.\d+$/
  script:
    - echo "üì¶ Cr√©ation de la release $CI_COMMIT_TAG"
  release:
    name: 'Release $CI_COMMIT_TAG'
    description: './CHANGELOG.md'
    tag_name: '$CI_COMMIT_TAG'
    ref: '$CI_COMMIT_SHA'
```

---

## Script de release

Cr√©ez `scripts/release.sh` :
```bash
#!/bin/bash
set -e

# Couleurs
GREEN='\033[0;32m'
RED='\033[0;31m'
NC='\033[0m'

info() { echo -e "${GREEN}[INFO]${NC} $1"; }
error() { echo -e "${RED}[ERROR]${NC} $1"; exit 1; }

# V√©rifications
command -v git-cliff &> /dev/null || error "git-cliff n'est pas install√©"
[[ -n $(git status -s) ]] && error "Vous avez des changements non commit√©s"

# R√©cup√©rer la version actuelle
current_version=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
current_version=${current_version#v}

info "Version actuelle: $current_version"

# Demander le type de release
echo ""
echo "Type de release:"
echo "1) major (x.0.0)"
echo "2) minor (0.x.0)"
echo "3) patch (0.0.x)"
read -p "Choisissez (1-3): " release_type

IFS='.' read -r major minor patch <<< "$current_version"

case $release_type in
    1) new_version="$((major + 1)).0.0" ;;
    2) new_version="$major.$((minor + 1)).0" ;;
    3) new_version="$major.$minor.$((patch + 1))" ;;
    *) error "Choix invalide" ;;
esac

info "Nouvelle version: v$new_version"

# Confirmation
read -p "Continuer? (y/n) " -n 1 -r
echo
[[ ! $REPLY =~ ^[Yy]$ ]] && error "Annul√©"

# G√©n√©rer le changelog
info "G√©n√©ration du changelog..."
git-cliff --tag "v$new_version" --output CHANGELOG.md

# Aper√ßu
echo ""
info "Aper√ßu:"
git-cliff --tag "v$new_version" --unreleased
echo ""

read -p "Le changelog vous convient? (y/n) " -n 1 -r
echo
[[ ! $REPLY =~ ^[Yy]$ ]] && error "Annul√©"

# Commit et tag
info "Commit du changelog..."
git add CHANGELOG.md
git commit -m "docs: update CHANGELOG.md for v$new_version"

info "Cr√©ation du tag..."
git tag -a "v$new_version" -m "Release v$new_version"

info "Push..."
git push origin main
git push origin "v$new_version"

info "‚úÖ Release v$new_version cr√©√©e!"
```
```bash
chmod +x scripts/release.sh
./scripts/release.sh
```

---

## Configuration avanc√©e (optionnelle)

### Pour un monorepo
```toml
# cliff-backend.toml
[git]
commit_parsers = [
    { message = "^feat\\(backend\\)", group = "‚ú® Nouvelles fonctionnalit√©s" },
    { message = "^fix\\(backend\\)", group = "üêõ Corrections" },
]
tag_pattern = "backend-v[0-9]*"
```
```bash
# G√©n√©rer le changelog backend uniquement
git-cliff --config cliff-backend.toml --include-path "backend/*" -o backend/CHANGELOG.md
```

### Avec int√©gration Jira
```toml
commit_preprocessors = [
    # Lier les tickets Jira
    { pattern = '([A-Z]+-\d+)', replace = "([${1}](https://votre-jira.atlassian.net/browse/${1}))" },
    # Lier les issues GitLab
    { pattern = '#(\d+)', replace = "([#${1}](https://gitlab.com/votre-org/votre-repo/-/issues/${1}))" },
]
```

---

## Git Hook pour validation des commits

Cr√©ez `.git/hooks/commit-msg` :
```bash
#!/bin/bash

commit_msg=$(cat "$1")
conventional_regex='^(feat|fix|docs|style|refactor|perf|test|build|ci|chore|revert)(\(.+\))?: .{1,}'

if ! echo "$commit_msg" | grep -qE "$conventional_regex"; then
  echo "‚ùå Message de commit invalide!"
  echo "Format: <type>(<scope>): <description>"
  echo ""
  echo "Exemples:"
  echo "  feat(auth): ajout OAuth2"
  echo "  fix(api): correction pagination"
  exit 1
fi
```
```bash
chmod +x .git/hooks/commit-msg
```

---

## Exemples de messages de commit
```bash
# Nouvelles fonctionnalit√©s
feat: ajout de l'export PDF
feat(auth): int√©gration Keycloak

# Corrections de bugs
fix: correction du bug de pagination
fix(api): gestion correcte des timeouts

# Breaking changes
feat!: suppression de l'API v1
BREAKING CHANGE: l'API v1 n'est plus support√©e

# Autres types
docs: mise √† jour du README
chore(deps): mise √† jour des d√©pendances
refactor: refactoring du service d'auth
perf: optimisation des requ√™tes SQL
test: ajout de tests unitaires
```

---

## Troubleshooting

### "No tags found"
```bash
# Cr√©er un tag initial
git tag v0.1.0
git push origin v0.1.0
```

### Commits non d√©tect√©s dans GitLab CI
```yaml
# Assurez-vous d'avoir dans .gitlab-ci.yml
variables:
  GIT_DEPTH: 0
```

### Tester la configuration
```bash
# Voir les commits qui seront inclus
git-cliff --unreleased --context | jq '.commits'

# Mode dry-run
git-cliff --unreleased --dry-run
```

---

## Checklist d'int√©gration

- [ ] Installer git-cliff : `cargo install git-cliff`
- [ ] Cr√©er `cliff.toml` √† la racine du projet
- [ ] Adapter les liens GitLab dans la configuration
- [ ] Ajouter le job dans `.gitlab-ci.yml`
- [ ] Cr√©er le script `scripts/release.sh`
- [ ] Ajouter le hook de validation des commits
- [ ] Tester avec `git-cliff --unreleased`
- [ ] Former l'√©quipe aux Conventional Commits
- [ ] Cr√©er votre premi√®re release : `./scripts/release.sh`

---

## Ressources

- [Documentation officielle](https://git-cliff.org/)
- [Conventional Commits](https://www.conventionalcommits.org/)
- [Keep a Changelog](https://keepachangelog.com/fr/)